apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: fluxgate

resources:
  - ../../base

namePrefix: prod-

labels:
  - pairs:
      environment: production

patches:
  # Production replicas for high availability
  - target:
      kind: Deployment
      name: fluxgate-backend
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1

  - target:
      kind: Deployment
      name: fluxgate-edge
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 1

  - target:
      kind: Deployment
      name: fluxgate-ui
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
      # Configure HTTPS and WSS for production
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: BACKEND_HOST
            value: api.fluxgate.example.com
          - name: BACKEND_PORT
            value: "443"
          - name: BACKEND_PROTOCOL
            value: https
          - name: WS_PROTOCOL
            value: wss

  # Use specific stable version tags for production
  - target:
      kind: Deployment
      name: fluxgate-backend
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: keaz/flux-gate-backend:v0.0.11-alpha-arm64 
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent

  - target:
      kind: Deployment
      name: fluxgate-edge
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: keaz/flux-gate-edge:v0.0.11-alpha-arm64 
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent

  - target:
      kind: Deployment
      name: fluxgate-ui
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent

  # Add production resource limits
  - target:
      kind: Deployment
      name: fluxgate-backend
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

  - target:
      kind: Deployment
      name: fluxgate-edge
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"

  - target:
      kind: Deployment
      name: fluxgate-ui
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "250m"

  # Add liveness and readiness probes
  - target:
      kind: Deployment
      name: fluxgate-backend
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /graphql
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /graphql
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5

  - target:
      kind: Deployment
      name: fluxgate-edge
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 10
          periodSeconds: 5

  # Add pod disruption budget annotation
  - target:
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/metadata/annotations
        value:
          prometheus.io/scrape: "true"

  # Update backend ConfigMap for production environment with cluster enabled
  - target:
      kind: ConfigMap
      name: fluxgate-backend-config
    patch: |-
      - op: replace
        path: /data/config.toml
        value: |
          # Feature Toggle Backend configuration

          # CORS allowed origin for the frontend
          allowed_origin = "https://fluxgate.example.com"

          # Address that the Actix-Web HTTP server binds to
          http_addr = "0.0.0.0:8080"

          # Address that the gRPC server binds to
          grpc_addr = "0.0.0.0:50051"

          # JWT secret for token signing and verification
          # IMPORTANT: Use external secret management (Sealed Secrets, Vault, etc.)
          jwt_secret = "CHANGE_ME_PRODUCTION_JWT_SECRET_MINIMUM_32_CHARACTERS_LONG"

          # Cluster replication enabled for production
          [cluster]
          enabled = true
          listen_addr = "0.0.0.0:6000"
          reconnect_delay_ms = 2000

          [cluster.discovery]
          heartbeat_interval_secs = 30
          stale_threshold_secs = 90
          cleanup_interval_secs = 60

  # Update edge ConfigMap for production environment
  - target:
      kind: ConfigMap
      name: fluxgate-edge-config
    patch: |-
      - op: replace
        path: /data/config.toml
        value: |
          # Edge Server Configuration

          # Backend gRPC server address
          backend_grpc = "http://prod-fluxgate-backend:50051"

          # HTTP server bind address
          http_addr = "0.0.0.0:8081"

          # Client credentials for backend authentication
          # IMPORTANT: Use external secret management (Sealed Secrets, Vault, etc.)
          client_id = "CHANGE_ME_PRODUCTION_CLIENT_ID"
          client_secret = "CHANGE_ME_PRODUCTION_CLIENT_SECRET"

          # gRPC connection settings
          [grpc]
          connect_timeout_secs = 5
          timeout_secs = 10
          tcp_keepalive_secs = 30
          http2_keepalive_secs = 20
          keep_alive_while_idle = true
          concurrency_limit = 256
          tcp_nodelay = true

          # Flush settings
          [flush]
          assignment_flush_secs = 10
          evaluation_flush_secs = 30

          # Retry settings
          [retry]
          base_delay_ms = 500
          max_attempts = 3
          stream_initial_delay_secs = 1
          stream_max_delay_secs = 30

  # Update Secret for production environment
  # NOTE: In production, use external secret management (e.g., Sealed Secrets, External Secrets Operator, Vault)
  - target:
      kind: Secret
      name: fluxgate-db
    patch: |-
      - op: replace
        path: /stringData/DATABASE_URL
        value: "postgres://postgres:CHANGE_ME@postgres-prod.example.com:5432/feature_toggle_production"
